<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nihilistic Penguin</title>
  <meta name="x-ogp-key" content="7fb8e9f8-b333-47f5-a0a0-f3dfa1ffdf6b" />
  <script src="https://sdk.play.fun"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0d1117;
      width: 100vw; height: 100vh;
      overflow: hidden;
      font-family: 'Georgia', serif;
    }
    #scene { position: relative; width: 100vw; height: 100vh; }

    #base-img {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover; object-position: center top;
      display: block;
    }

    .overlay-canvas {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }

    #grade-overlay {
      position: absolute; inset: 0;
      pointer-events: none;
      transition: background 8s ease;
    }

    #rays-canvas {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    #vignette {
      position: absolute; inset: 0;
      background: radial-gradient(ellipse at center, transparent 35%, rgba(5,8,18,0.60) 100%);
      pointer-events: none;
    }

    #breath-canvas {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }

    #title {
      position: absolute; top: 28px; right: 32px;
      text-align: right; pointer-events: none;
    }
    #title .main {
      color: rgba(200,215,235,0.55); font-size: 15px;
      letter-spacing: 5px; text-transform: uppercase;
    }
    #title .sub {
      color: rgba(160,180,210,0.3); font-size: 10px;
      letter-spacing: 3px; margin-top: 4px;
    }

    #weather-label {
      position: absolute; top: 28px; left: 32px;
      color: rgba(180,200,230,0.55); font-size: 12px;
      letter-spacing: 4px; text-transform: uppercase;
      pointer-events: none;
      transition: opacity 2s ease;
    }

    #score-widget {
      position: absolute; bottom: 32px; right: 32px;
      text-align: right; pointer-events: none;
    }
    #score-widget .label {
      color: rgba(180,200,220,0.45); font-size: 11px;
      letter-spacing: 3px; text-transform: uppercase; margin-bottom: 4px;
    }
    #score-widget .value {
      color: rgba(200,220,240,0.75); font-size: 28px;
      text-shadow: 0 0 12px rgba(120,160,220,0.4); letter-spacing: 2px;
    }

    #commit-toast {
      position: absolute; bottom: 80px; right: 32px;
      color: rgba(140,180,220,0.6); font-size: 11px;
      letter-spacing: 3px; text-transform: uppercase;
      opacity: 0; transition: opacity 1.5s ease;
      pointer-events: none;
    }

    #start-screen {
      position: fixed; inset: 0; z-index: 999;
      background: rgba(8,12,22,0.93);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      gap: 24px; cursor: pointer;
    }
    #start-screen h1 {
      color: rgba(200,215,235,0.7);
      font-size: clamp(22px,4vw,38px);
      font-weight: normal; letter-spacing: 8px; text-transform: uppercase;
    }
    #start-screen p {
      color: rgba(160,180,210,0.35); font-size: 12px;
      letter-spacing: 4px; text-transform: uppercase;
    }
    #start-screen .dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: rgba(200,220,240,0.4);
      animation: blink 2s ease-in-out infinite;
    }
    @keyframes blink { 0%,100%{opacity:0.2} 50%{opacity:0.8} }
  </style>
</head>
<body>

<div id="start-screen">
  <h1>Nihilistic Penguin</h1>
  <p>tap anywhere to begin</p>
  <div class="dot"></div>
</div>

<div id="scene">
  <img id="base-img" src="image.jpg" alt="" />
  <div id="grade-overlay"></div>
  <canvas id="rays-canvas"   class="overlay-canvas"></canvas>
  <canvas id="snow-canvas"   class="overlay-canvas"></canvas>
  <canvas id="fog-canvas"    class="overlay-canvas"></canvas>
  <canvas id="fx-canvas"     class="overlay-canvas"></canvas>
  <canvas id="breath-canvas" class="overlay-canvas"></canvas>
  <div id="vignette"></div>

  <div id="title">
    <div class="main">Nihilistic Penguin</div>
    <div class="sub">a meditation</div>
  </div>
  <div id="weather-label">calm</div>
  <div id="score-widget">
    <div class="label">points</div>
    <div class="value" id="score-val">0</div>
  </div>
  <div id="commit-toast">saved ✓</div>
</div>

<script>
// ── Helpers ───────────────────────────────────────────────────────────────────
function rnd(a,b){ return a+Math.random()*(b-a); }
function lerp(a,b,t){ return a+(b-a)*t; }
function eio(t){ return t<0.5?2*t*t:-1+(4-2*t)*t; }

// ── Canvas setup ──────────────────────────────────────────────────────────────
const rCanvas=document.getElementById('rays-canvas');   const rCtx=rCanvas.getContext('2d');
const sCanvas=document.getElementById('snow-canvas');   const sCtx=sCanvas.getContext('2d');
const fCanvas=document.getElementById('fog-canvas');    const fCtx=fCanvas.getContext('2d');
const xCanvas=document.getElementById('fx-canvas');     const xCtx=xCanvas.getContext('2d');
const bCanvas=document.getElementById('breath-canvas'); const bCtx=bCanvas.getContext('2d');

function resize(){
  [rCanvas,sCanvas,fCanvas,xCanvas,bCanvas].forEach(c=>{
    c.width=window.innerWidth; c.height=window.innerHeight;
  });
}
resize();
window.addEventListener('resize',resize);

function penguinHead(){ return{x:window.innerWidth*0.5,y:window.innerHeight*0.54}; }

// ── Weather ───────────────────────────────────────────────────────────────────
const STATES={
  sunny:    {snow:0.0, wind:0,   fog:0.02,grade:'rgba(255,240,180,0.08)',label:'sunny',     rays:0.9 },
  calm:     {snow:0.0, wind:0,   fog:0.04,grade:'rgba(20,30,55,0.10)',   label:'calm',      rays:0.15},
  haze:     {snow:0.0, wind:0,   fog:0.28,grade:'rgba(180,195,215,0.22)',label:'haze',      rays:0.0 },
  lightSnow:{snow:0.20,wind:0.5, fog:0.10,grade:'rgba(15,25,45,0.20)',   label:'light snow',rays:0.0 },
  snowfall: {snow:0.50,wind:1.2, fog:0.16,grade:'rgba(10,18,38,0.28)',   label:'snowfall',  rays:0.0 },
  overcast: {snow:0.05,wind:0.3, fog:0.20,grade:'rgba(30,35,55,0.35)',   label:'overcast',  rays:0.0 },
  blizzard: {snow:0.88,wind:5.0, fog:0.28,grade:'rgba(8,12,30,0.42)',    label:'blizzard',  rays:0.0 },
  whiteout: {snow:1.0, wind:9.5, fog:0.60,grade:'rgba(210,220,235,0.32)',label:'whiteout',  rays:0.0 },
  clearing: {snow:0.05,wind:0.2, fog:0.05,grade:'rgba(30,50,80,0.06)',   label:'clearing',  rays:0.3 },
};
const WEIGHTS={sunny:1.5,calm:3,haze:2,lightSnow:3,snowfall:2,overcast:2,blizzard:1,whiteout:0.4,clearing:1.5};
const KEYS=Object.keys(STATES);

let curKey='calm',prevSnap={...STATES.calm},curSnap={...STATES.calm};
let blend=1,stateTimer=0,stateInterval=rnd(20,42);
let snow=0,wind=0,fog=0.04,rays=0.15;

function pickNext(){
  const opts=KEYS.filter(k=>k!==curKey);
  const tot=opts.reduce((s,k)=>s+WEIGHTS[k],0);
  let r=Math.random()*tot;
  for(const k of opts){r-=WEIGHTS[k];if(r<=0)return k;}
  return opts[0];
}

function updateWeather(dt){
  stateTimer+=dt;
  if(stateTimer>=stateInterval){
    stateTimer=0; stateInterval=rnd(20,48);
    prevSnap={snow,wind,fog,rays,grade:curSnap.grade};
    curKey=pickNext(); curSnap={...STATES[curKey]};
    blend=0;
    fadeLabel(curSnap.label);
  }
  blend=Math.min(1,blend+dt/10);
  const t=eio(blend);
  snow=lerp(prevSnap.snow,curSnap.snow,t);
  wind=lerp(prevSnap.wind,curSnap.wind,t);
  fog =lerp(prevSnap.fog, curSnap.fog, t);
  rays=lerp(prevSnap.rays||0,curSnap.rays||0,t);
  document.getElementById('grade-overlay').style.background=t>0.5?curSnap.grade:prevSnap.grade;
}

function fadeLabel(txt){
  const el=document.getElementById('weather-label');
  el.style.opacity='0';
  setTimeout(()=>{el.textContent=txt;el.style.opacity='1';},2200);
}

// ── Sun rays ──────────────────────────────────────────────────────────────────
let rayAngle=0;
function drawRays(){
  rCtx.clearRect(0,0,rCanvas.width,rCanvas.height);
  if(rays<0.02)return;
  rayAngle+=0.0003;
  const ox=rCanvas.width*0.62,oy=rCanvas.height*0.08;
  for(let i=0;i<14;i++){
    const ba=(i/14)*Math.PI+Math.PI*0.25+rayAngle;
    const len=rCanvas.height*1.8,sp=0.018;
    const a=rays*0.045*(i%3===0?1.4:0.7);
    const grd=rCtx.createLinearGradient(ox,oy,ox+Math.cos(ba)*len,oy+Math.sin(ba)*len);
    grd.addColorStop(0,`rgba(255,248,200,${a})`);
    grd.addColorStop(0.4,`rgba(255,240,180,${a*0.4})`);
    grd.addColorStop(1,'rgba(255,240,180,0)');
    rCtx.beginPath();
    rCtx.moveTo(ox,oy);
    rCtx.lineTo(ox+Math.cos(ba-sp)*len,oy+Math.sin(ba-sp)*len);
    rCtx.lineTo(ox+Math.cos(ba+sp)*len,oy+Math.sin(ba+sp)*len);
    rCtx.closePath(); rCtx.fillStyle=grd; rCtx.fill();
  }
  if(rays>0.3){
    const h=rCtx.createRadialGradient(ox,oy,0,ox,oy,rCanvas.width*0.35);
    h.addColorStop(0,`rgba(255,248,200,${rays*0.12})`);
    h.addColorStop(0.3,`rgba(255,240,160,${rays*0.04})`);
    h.addColorStop(1,'rgba(255,240,160,0)');
    rCtx.fillStyle=h; rCtx.fillRect(0,0,rCanvas.width,rCanvas.height);
  }
}

// ── Snow ──────────────────────────────────────────────────────────────────────
const MAX_FLAKES=750;
const flakes=Array.from({length:MAX_FLAKES},()=>makeFlake(false));
function makeFlake(fromTop){
  return{x:Math.random()*window.innerWidth,y:fromTop?rnd(-8,-1):Math.random()*window.innerHeight,
    r:rnd(0.4,2.5),vx:rnd(-0.4,0.4),vy:rnd(0.5,2.2),a:rnd(0.2,0.85),wb:Math.random()*Math.PI*2,ws:rnd(0.012,0.038)};
}
function drawSnow(){
  sCtx.clearRect(0,0,sCanvas.width,sCanvas.height);
  const active=Math.floor(snow*MAX_FLAKES);
  if(active<3)return;
  for(let i=0;i<active;i++){
    const f=flakes[i];
    f.wb+=f.ws; f.x+=f.vx+wind+Math.sin(f.wb)*0.35; f.y+=f.vy*(1+Math.abs(wind)*0.05);
    if(f.y>sCanvas.height+6||f.x<-20||f.x>sCanvas.width+20){
      Object.assign(f,makeFlake(true));
      f.x=wind>1?rnd(-15,5):wind<-1?rnd(sCanvas.width-5,sCanvas.width+15):Math.random()*sCanvas.width;
    }
    sCtx.beginPath(); sCtx.arc(f.x,f.y,f.r,0,Math.PI*2);
    sCtx.fillStyle=`rgba(230,238,252,${f.a*Math.min(1,snow*2.2)})`; sCtx.fill();
  }
}

// ── Fog ───────────────────────────────────────────────────────────────────────
const fogLayers=Array.from({length:6},(_,i)=>({
  x:Math.random()*window.innerWidth,y:window.innerHeight*(0.12+i*0.10),
  rx:rnd(250,620),ry:rnd(50,115),vx:rnd(-0.10,0.10),ba:rnd(0.05,0.13),
}));
function drawFog(){
  fCtx.clearRect(0,0,fCanvas.width,fCanvas.height);
  if(fog<0.03)return;
  fogLayers.forEach(l=>{
    l.x+=l.vx;
    if(l.x>fCanvas.width+l.rx)l.x=-l.rx;
    if(l.x<-l.rx)l.x=fCanvas.width+l.rx;
    const g=fCtx.createRadialGradient(l.x,l.y,0,l.x,l.y,l.rx);
    g.addColorStop(0,`rgba(205,218,236,${l.ba*fog*5.5})`);
    g.addColorStop(1,'rgba(205,218,236,0)');
    fCtx.fillStyle=g; fCtx.beginPath();
    fCtx.ellipse(l.x,l.y,l.rx,l.ry,0,0,Math.PI*2); fCtx.fill();
  });
}

// ── Whiteout FX ───────────────────────────────────────────────────────────────
let fxA=0;
function drawFX(){
  xCtx.clearRect(0,0,xCanvas.width,xCanvas.height);
  const target=snow>0.75?(snow-0.75)*1.1:0;
  fxA+=(target-fxA)*0.008;
  if(fxA>0.01){xCtx.fillStyle=`rgba(215,225,242,${Math.min(fxA,0.32)})`;xCtx.fillRect(0,0,xCanvas.width,xCanvas.height);}
}

// ── Penguin breath ────────────────────────────────────────────────────────────
const breathPuffs=[];
let breathTimer=0;
function spawnBreath(){
  const h=penguinHead();
  for(let i=0;i<6;i++)
    breathPuffs.push({x:h.x+rnd(-8,8),y:h.y+rnd(-5,5),vx:rnd(-0.25,0.10),vy:rnd(-0.5,-0.15),r:rnd(2,5),life:1.0,decay:rnd(0.003,0.006)});
}
function updateBreath(dt){
  breathTimer+=dt;
  if(breathTimer>=3.8){breathTimer=0;spawnBreath();}
  bCtx.clearRect(0,0,bCanvas.width,bCanvas.height);
  for(let i=breathPuffs.length-1;i>=0;i--){
    const p=breathPuffs[i];
    p.x+=p.vx; p.y+=p.vy; p.r+=0.03; p.life-=p.decay;
    if(p.life<=0){breathPuffs.splice(i,1);continue;}
    bCtx.beginPath(); bCtx.arc(p.x,p.y,p.r,0,Math.PI*2);
    bCtx.fillStyle=`rgba(240,245,255,${p.life*0.28})`; bCtx.fill();
  }
}

// ── Audio ─────────────────────────────────────────────────────────────────────
let audioCtx=null, windGainNode=null;

function startMusic(){
  if(audioCtx)return;
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended')audioCtx.resume();

  const master=audioCtx.createGain();
  master.gain.setValueAtTime(0,audioCtx.currentTime);
  master.gain.linearRampToValueAtTime(0.22,audioCtx.currentTime+8);
  master.connect(audioCtx.destination);

  const rLen=audioCtx.sampleRate*5.5;
  const rBuf=audioCtx.createBuffer(2,rLen,audioCtx.sampleRate);
  for(let ch=0;ch<2;ch++){const d=rBuf.getChannelData(ch);for(let i=0;i<rLen;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/rLen,1.6);}
  const rev=audioCtx.createConvolver(); rev.buffer=rBuf;
  const revG=audioCtx.createGain(); revG.gain.value=0.5;
  rev.connect(revG); revG.connect(master);

  const lpf=audioCtx.createBiquadFilter();
  lpf.type='lowpass'; lpf.frequency.value=520; lpf.Q.value=0.45;
  lpf.connect(master); lpf.connect(rev);

  const nLen=audioCtx.sampleRate*3;
  const nBuf=audioCtx.createBuffer(1,nLen,audioCtx.sampleRate);
  const nd=nBuf.getChannelData(0); for(let i=0;i<nLen;i++)nd[i]=Math.random()*2-1;
  const nSrc=audioCtx.createBufferSource(); nSrc.buffer=nBuf; nSrc.loop=true;
  const bp=audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=250; bp.Q.value=0.3;
  windGainNode=audioCtx.createGain(); windGainNode.gain.value=0.025;
  nSrc.connect(bp); bp.connect(windGainNode); windGainNode.connect(master); nSrc.start();

  [[36.7,'sine',0.18],[55,'sine',0.14],[73.4,'triangle',0.07],[110,'triangle',0.04]].forEach(([f,type,vol],i)=>{
    const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
    osc.type=type; osc.frequency.value=f; osc.detune.value=(i%2?4:-4);
    g.gain.setValueAtTime(0,audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(vol,audioCtx.currentTime+10+i*2.5);
    osc.connect(g); g.connect(lpf); osc.start();
  });

  const scale=[73.4,82.4,87.3,110,130.8,146.8,174.6,220,261.6,293.7];
  const seq=[0,2,4,3,6,5,3,1,0,4,2,8,5,0,7,3];
  let mi=0,noteT=audioCtx.currentTime+5;
  function schedMelody(){
    while(noteT<audioCtx.currentTime+25){
      const freq=scale[seq[mi++%seq.length]];
      const osc=audioCtx.createOscillator(); const env=audioCtx.createGain();
      osc.type='sine'; osc.frequency.value=freq; osc.detune.value=(Math.random()-0.5)*9;
      const t=noteT;
      env.gain.setValueAtTime(0,t); env.gain.linearRampToValueAtTime(0.065,t+1.5);
      env.gain.setValueAtTime(0.065,t+5.5); env.gain.linearRampToValueAtTime(0,t+7.5);
      osc.connect(env); env.connect(lpf); osc.start(t); osc.stop(t+7.6);
      noteT+=7.5*rnd(0.5,1.0);
      if(Math.random()<0.28){
        const o2=audioCtx.createOscillator(); const e2=audioCtx.createGain();
        o2.type='sine'; o2.frequency.value=freq*1.5;
        e2.gain.setValueAtTime(0,t); e2.gain.linearRampToValueAtTime(0.022,t+1.8); e2.gain.linearRampToValueAtTime(0,t+5.5);
        o2.connect(e2); e2.connect(lpf); o2.start(t); o2.stop(t+7.5);
      }
    }
    setTimeout(schedMelody,10000);
  }
  schedMelody();

  let pT=audioCtx.currentTime+12;
  function schedPulse(){
    while(pT<audioCtx.currentTime+40){
      const osc=audioCtx.createOscillator(); const env=audioCtx.createGain();
      osc.type='sine'; osc.frequency.value=55;
      env.gain.setValueAtTime(0,pT); env.gain.linearRampToValueAtTime(0.09,pT+0.12);
      env.gain.exponentialRampToValueAtTime(0.001,pT+2.5);
      osc.connect(env); env.connect(rev); osc.start(pT); osc.stop(pT+3);
      pT+=rnd(9,17);
    }
    setTimeout(schedPulse,14000);
  }
  schedPulse();
}

function playSnowCrunch(){
  if(!audioCtx)return;
  const buf=audioCtx.createBuffer(1,Math.floor(audioCtx.sampleRate*0.18),audioCtx.sampleRate);
  const d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,3.5);
  const src=audioCtx.createBufferSource();
  const hpf=audioCtx.createBiquadFilter(); hpf.type='highpass'; hpf.frequency.value=900;
  const g=audioCtx.createGain(); g.gain.value=rnd(0.06,0.13);
  src.buffer=buf; src.connect(hpf); hpf.connect(g); g.connect(audioCtx.destination); src.start();
}

let crunchTimer=rnd(8,18);
function updateCrunch(dt){
  crunchTimer-=dt;
  if(crunchTimer<=0){
    crunchTimer=rnd(8,18); playSnowCrunch();
    if(Math.random()<0.4)setTimeout(playSnowCrunch,rnd(120,280));
  }
}

function updateWindSound(){
  if(!windGainNode||!audioCtx)return;
  windGainNode.gain.setTargetAtTime(0.008+Math.abs(wind)*0.008,audioCtx.currentTime,2);
}

// ── Score & SDK ───────────────────────────────────────────────────────────────
let score=0,scoreAcc=0;
let ppm=rnd(1,4),ppmT=0,ppmChange=rnd(60,180);
let commitT=0,commitInterval=rnd(120,300);
let sdkReady=false,_sdk=null;

window.addEventListener('load',()=>{
  if(typeof OpenGameSDK!=='undefined'){
    _sdk=new OpenGameSDK({ui:{usePointsWidget:true}});
    _sdk.on('OnReady',()=>{ sdkReady=true; console.log('SDK ready'); });
    _sdk.init({gameId:'7d97fb68-aad5-4c8d-8b01-335f6e6b4144'})
      .catch((e)=>console.error('SDK error',e));
  }
});

function updateScore(dt){
  ppmT+=dt;
  if(ppmT>=ppmChange){ppm=rnd(1,4);ppmChange=rnd(60,180);ppmT=0;}
  scoreAcc+=(ppm/60)*dt;
  if(scoreAcc>=1){
    const pts=Math.floor(scoreAcc); score+=pts; scoreAcc-=pts;
    document.getElementById('score-val').textContent=score;
    if(sdkReady&&_sdk)_sdk.addPoints(pts);
  }
  commitT+=dt;
  if(commitT>=commitInterval){commitT=0;commitInterval=rnd(120,300);doCommit();}
}

async function doCommit(){
  if(sdkReady&&_sdk){
    try{ await _sdk.endGame(); }catch(e){}
  }
  const t=document.getElementById('commit-toast');
  t.style.opacity='1'; setTimeout(()=>{t.style.opacity='0';},3000);
}

// ── Main loop ─────────────────────────────────────────────────────────────────
let last=null;
function loop(ts){
  if(!last)last=ts;
  const dt=Math.min((ts-last)/1000,0.1); last=ts;
  updateWeather(dt);
  drawRays(); drawSnow(); drawFog(); drawFX();
  updateBreath(dt); updateCrunch(dt); updateWindSound();
  updateScore(dt);
  requestAnimationFrame(loop);
}

// ── Start ─────────────────────────────────────────────────────────────────────
document.getElementById('start-screen').addEventListener('click',()=>{
  document.getElementById('start-screen').style.display='none';
  startMusic();
  requestAnimationFrame(loop);
},{once:true});
</script>
</body>
</html>